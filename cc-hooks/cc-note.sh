#!/usr/bin/env bash
# cc-note.sh - Generate session hand-off note template
# ---------------------------------------------
# Usage:  cc-hooks/cc-note.sh [--yes]
#   --yes   : non-interactive; overwrite existing file if any
#
# This script creates a Markdown hand-off note under
#   ./.ccflow/NOTE/YYYY-MM-DD-HHMM-handoff.md
# with a pre-formatted template.  It is safe to rerun; if the target file
# already exists it opens the file in $EDITOR unless --yes is given.
# ---------------------------------------------
set -euo pipefail

YES_MODE=false
FULL_MODE=false
for arg in "$@"; do
  case "$arg" in
    --yes) YES_MODE=true ;;
    --full) FULL_MODE=true ;;
  esac
  shift || true
done

# --------------------------------------------------
# Load project configuration (YAML) if present
# --------------------------------------------------
CCFLOW_DIR=".ccflow"
CONFIG_FILE="$CCFLOW_DIR/config"
YQ_BIN="$(command -v yq || true)"
DEFAULT_MODE="summary"
TEMPLATE_PATH=""
INCLUDE_SECTIONS=()
EXTRA_SECTIONS=()
OWNERS=()
CI_BADGE=""

if [[ -f "$CONFIG_FILE" ]]; then
  echo "[cc-note] Using config $CONFIG_FILE" >&2
  if [[ -n "$YQ_BIN" ]]; then
    DEFAULT_MODE="$($YQ_BIN e '.note.default_mode // "summary"' "$CONFIG_FILE" 2>/dev/null)"
    TEMPLATE_PATH="$($YQ_BIN e '.note.template // ""' "$CONFIG_FILE" 2>/dev/null)"
    mapfile -t INCLUDE_SECTIONS < <($YQ_BIN e '.note.include_readme_sections[]' "$CONFIG_FILE" 2>/dev/null || true)
    mapfile -t EXTRA_SECTIONS < <($YQ_BIN e '.note.extra_sections[]' "$CONFIG_FILE" 2>/dev/null || true)
    mapfile -t OWNERS < <($YQ_BIN e '.project.owners[]' "$CONFIG_FILE" 2>/dev/null || true)
    CI_BADGE="$($YQ_BIN e '.ci.badge_url // ""' "$CONFIG_FILE" 2>/dev/null)"
  else
    # minimal parser: key: value at root level
    while IFS=: read -r key val; do
      key=$(echo "$key" | xargs)
      val=$(echo "$val" | xargs)
      case "$key" in
        default_mode) DEFAULT_MODE="$val" ;;
      esac
    done < <(grep -E 'default_mode:' "$CONFIG_FILE" || true)
  fi
fi

if [[ $FULL_MODE == false && $DEFAULT_MODE == "full" ]]; then
  FULL_MODE=true
fi

# Determine timestamp (local time)
TS=$(date +"%Y-%m-%d-%H%M")
NOTE_DIR=".ccflow/NOTE"
FILE="${NOTE_DIR}/${TS}-handoff.md"

mkdir -p "$NOTE_DIR"

if [[ -f "$FILE" && $YES_MODE == false ]]; then
  echo "[cc-note] $FILE already exists. Open in \$EDITOR? [y/N]" >&2
  read -r ans
  [[ "$ans" =~ ^[Yy]$ ]] || { echo "Aborted."; exit 1; }
fi

cat > "$FILE" <<EOF
# ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å…±æœ‰ - ${TS}

## ğŸ¯ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¦‚è¦
- **é–‹å§‹æ™‚åˆ»**: <!-- ä¾‹: 2025-07-21 09:00 -->
- **çµ‚äº†æ™‚åˆ»**: <!-- ä¾‹: 2025-07-21 17:30 -->
- **ç’°å¢ƒ**: <!-- bash 5.1, git 2.40 ãªã© -->
- **ä½œæ¥­æ™‚é–“**: <!-- ä¾‹: 6æ™‚é–“30åˆ† -->

## âœ… å®Œäº†ã—ãŸä½œæ¥­
### [L] ä½è¤‡é›‘åº¦ã‚¿ã‚¹ã‚¯
- 
### [M] ä¸­è¤‡é›‘åº¦ã‚¿ã‚¹ã‚¯
- 
### [H] é«˜è¤‡é›‘åº¦ã‚¿ã‚¹ã‚¯
- 

## ğŸ”„ é€²è¡Œä¸­ã®ä½œæ¥­
### ç¾åœ¨ã®çŠ¶æ³
- 
### æŠ€è¡“çš„æ±ºå®šäº‹é …
- 
### ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ
- 

## ğŸ“‹ æ¬¡å›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¸ã®å¼•ãç¶™ã
1. 
2. 

## ğŸ§  æ¨å¥¨æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- 

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- 

## ğŸ—º ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç¾åœ¨åœ°
- **ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³**: <!-- ä¾‹: v1.0 Alpha -->
- **æœŸæ—¥**: <!-- ä¾‹: 2025-07-31 -->

## ğŸ”€ ä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒ & ç›´è¿‘ã‚³ãƒŸãƒƒãƒˆ
- **Branch**: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "(unknown)")
- **Commit**:  $(git log -1 --pretty="%h %s" 2>/dev/null || echo "(unknown)")

## â­• æœªå®Œäº†ã‚¿ã‚¹ã‚¯ä¸€è¦§
- [ ] <!-- å„ªå…ˆåº¦: èª°ãŒä½•ã‚’ã€è¦‹ç© -->

## ğŸ—‚ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
$(if [[ $FULL_MODE == true ]]; then
  # æŠœç²‹: README ã®ã€ŒèƒŒæ™¯ã¨ç›®çš„ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (è¦‹å‡ºã—## èƒŒæ™¯ã¨ç›®çš„ ã‹ã‚‰æ¬¡ã® --- ã¾ã§)
  awk '/^## èƒŒæ™¯ã¨ç›®çš„/{flag=1;next}/^---/{flag=0}flag' README.md | sed 's/^/- /'
fi)

## ğŸ“‚ é‡è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«
$(if [[ $FULL_MODE == true ]]; then
  awk '/^## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ/{flag=1;next}/^---/{flag=0}flag' README.md
fi)

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
$(if [[ $FULL_MODE == true ]]; then
  awk '/^## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ/{flag=1;next}/^##/{if(flag && NR>1)exit}flag' README.md
fi)

## â• è¿½åŠ æƒ…å ±
$(for sec in "${EXTRA_SECTIONS[@]}"; do
  case "$sec" in
    ci_status)
      if [[ -n "$CI_BADGE" ]]; then
        echo "### CI Status"
        echo "![CI Status]($CI_BADGE)"
        echo
      fi
      ;;
    contacts)
      if [[ ${#OWNERS[@]} -gt 0 ]]; then
        echo "### Contacts"
        for o in "${OWNERS[@]}"; do echo "- $o"; done
        echo
      fi
      ;;
    *)
      # treat as file path if exists
      if [[ -f "$sec" ]]; then
        echo "### $(basename "$sec")"
        cat "$sec"
        echo
      fi
      ;;
  esac
done)

---
*Generated by cc-note.sh (${FULL_MODE:+full})*
EOF

printf "[cc-note] Created %s\n" "$FILE"
